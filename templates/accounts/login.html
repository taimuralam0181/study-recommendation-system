{% extends "base.html" %}

{% block title %}Login | Study Recommender{% endblock %}
{% block show_navbar %}{% endblock %}

{% block content %}
<style>
  @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap");

  body > nav.navbar {
    display: none !important;
  }

  .login-shell {
    --shell-top: #0b1139;
    --shell-mid: #2e0f58;
    --shell-bottom: #5e1149;
    --left-panel: linear-gradient(160deg, rgba(9, 16, 63, 0.86), rgba(64, 10, 100, 0.5));
    --right-panel: linear-gradient(170deg, rgba(44, 15, 83, 0.55), rgba(110, 7, 62, 0.42));
    --title: #48e5ff;
    --text-main: #f5f8ff;
    --text-soft: rgba(232, 237, 255, 0.82);
    --line-soft: rgba(255, 255, 255, 0.17);
    --input-bg: rgba(255, 255, 255, 0.95);
    --input-text: #1f2550;
    --input-border: rgba(236, 242, 255, 0.42);
    --input-focus: rgba(71, 228, 255, 0.22);
    --btn-from: #ff3fbc;
    --btn-to: #ff75df;
    --btn-shadow: rgba(255, 63, 188, 0.28);
    --orb-left: rgba(71, 228, 255, 0.35);
    --orb-right: rgba(255, 63, 188, 0.32);
    --alert-border: rgba(255, 125, 140, 0.52);
    --alert-bg: rgba(132, 5, 50, 0.35);
    --alert-text: #ffe0e7;

    position: relative;
    min-height: calc(100vh - 190px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: clamp(1rem, 2.8vw, 2rem) 0;
    font-family: "Space Grotesk", sans-serif;
    overflow: hidden;
  }

  .login-shell::before,
  .login-shell::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    filter: blur(2px);
    pointer-events: none;
    animation: floatOrb 10s ease-in-out infinite;
  }

  .login-shell::before {
    width: 260px;
    height: 260px;
    top: 10%;
    left: -80px;
    background: radial-gradient(circle, var(--orb-left), rgba(71, 228, 255, 0));
  }

  .login-shell::after {
    width: 290px;
    height: 290px;
    right: -100px;
    bottom: 5%;
    background: radial-gradient(circle, var(--orb-right), rgba(255, 63, 188, 0));
    animation-delay: -4s;
  }

  .login-shell[data-theme="light"] {
    --shell-top: #e8f6ff;
    --shell-mid: #f1f3ff;
    --shell-bottom: #ffe9f4;
    --left-panel: linear-gradient(160deg, rgba(222, 245, 255, 0.95), rgba(228, 231, 255, 0.95));
    --right-panel: linear-gradient(170deg, rgba(255, 255, 255, 0.92), rgba(245, 248, 255, 0.95));
    --title: #0f4cbf;
    --text-main: #172046;
    --text-soft: rgba(26, 38, 79, 0.78);
    --line-soft: rgba(14, 42, 108, 0.15);
    --input-bg: #ffffff;
    --input-text: #1e2551;
    --input-border: rgba(24, 46, 108, 0.26);
    --input-focus: rgba(73, 123, 255, 0.18);
    --btn-from: #3074ff;
    --btn-to: #55b4ff;
    --btn-shadow: rgba(68, 118, 255, 0.3);
    --orb-left: rgba(0, 174, 255, 0.22);
    --orb-right: rgba(255, 89, 194, 0.22);
    --alert-border: rgba(255, 76, 76, 0.4);
    --alert-bg: rgba(255, 124, 124, 0.15);
    --alert-text: #8f1a37;
  }

  .login-shell.error-mode {
    --shell-top: #261022;
    --shell-mid: #551430;
    --shell-bottom: #8a1b35;
    --btn-from: #ff335d;
    --btn-to: #ff8f6d;
    --btn-shadow: rgba(255, 74, 74, 0.36);
    --orb-left: rgba(255, 95, 120, 0.26);
    --orb-right: rgba(255, 42, 92, 0.3);
  }

  .login-frame {
    position: relative;
    width: min(1020px, 100%);
    border-radius: 26px;
    border: 1px solid var(--line-soft);
    overflow: hidden;
    background:
      radial-gradient(circle at 0% 100%, rgba(64, 219, 255, 0.3), transparent 34%),
      radial-gradient(circle at 100% 0%, rgba(255, 54, 187, 0.3), transparent 38%),
      linear-gradient(132deg, var(--shell-top) 0%, var(--shell-mid) 45%, var(--shell-bottom) 100%);
    box-shadow: 0 28px 68px rgba(8, 3, 35, 0.6);
    animation: slideUp 0.7s ease both;
  }

  .login-grid {
    display: grid;
    grid-template-columns: 1.06fr 1.2fr;
    min-height: 560px;
  }

  .login-info {
    padding: clamp(1.6rem, 3.4vw, 2.4rem);
    background: var(--left-panel);
    border-right: 1px solid var(--line-soft);
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: var(--text-main);
  }

  .info-badge {
    display: inline-flex;
    align-items: center;
    width: fit-content;
    gap: 0.4rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--title) 55%, transparent);
    padding: 0.35rem 0.72rem;
    font-size: 0.78rem;
    color: color-mix(in srgb, var(--title) 80%, #fff 20%);
    margin-bottom: 1rem;
    letter-spacing: 0.02em;
    opacity: 0;
    animation: fadeIn 0.7s ease forwards;
    animation-delay: 0.2s;
  }

  .info-title {
    margin: 0;
    font-size: clamp(1.95rem, 4vw, 2.85rem);
    line-height: 1.08;
    font-weight: 700;
    opacity: 0;
    animation: fadeIn 0.7s ease forwards;
    animation-delay: 0.32s;
  }

  .info-text {
    margin: 1rem 0 1.4rem;
    color: var(--text-soft);
    font-size: 0.95rem;
    max-width: 34ch;
    opacity: 0;
    animation: fadeIn 0.7s ease forwards;
    animation-delay: 0.45s;
  }

  .info-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 0.55rem;
    opacity: 0;
    animation: fadeIn 0.7s ease forwards;
    animation-delay: 0.56s;
  }

  .info-list li {
    font-size: 0.87rem;
    color: color-mix(in srgb, var(--text-main) 88%, transparent);
  }

  .login-form-wrap {
    position: relative;
    padding: clamp(1.4rem, 2.9vw, 2.3rem);
    color: var(--text-main);
    background: var(--right-panel);
  }

  .login-form-wrap::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.09) 48%, transparent 100%);
    transform: translateX(-130%);
    animation: lightSweep 3.9s ease-in-out infinite;
    pointer-events: none;
  }

  .login-title {
    margin: 0;
    color: var(--title);
    font-weight: 700;
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }

  .reaction-emoji {
    display: inline-block;
    font-size: 1.55rem;
    line-height: 1;
    transform-origin: center;
    animation: faceFloat 2.2s ease-in-out infinite;
  }

  .form-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.7rem;
  }

  .theme-toggle {
    border: 1px solid var(--line-soft);
    background: color-mix(in srgb, var(--input-bg) 34%, transparent);
    color: var(--text-main);
    border-radius: 999px;
    padding: 0.33rem 0.7rem;
    font-size: 0.78rem;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease;
  }

  .theme-toggle:hover {
    transform: translateY(-1px);
    background: color-mix(in srgb, var(--input-bg) 54%, transparent);
  }

  .login-subtitle {
    margin: 0.35rem 0 1.15rem;
    color: var(--text-soft);
    font-size: 0.9rem;
  }

  .login-alert {
    margin-bottom: 0.95rem;
    border-radius: 10px;
    border: 1px solid var(--alert-border);
    background: var(--alert-bg);
    color: var(--alert-text);
    padding: 0.62rem 0.72rem 0.68rem;
    font-size: 0.9rem;
  }

  .alert-topline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.42rem;
  }

  .denied-pill {
    border: 1px solid color-mix(in srgb, var(--alert-text) 45%, transparent);
    border-radius: 999px;
    padding: 0.15rem 0.56rem;
    font-size: 0.68rem;
    letter-spacing: 0.04em;
    font-weight: 700;
    text-transform: uppercase;
  }

  .base-error {
    font-size: 0.78rem;
    opacity: 0.9;
  }

  .funny-line {
    min-height: 1.3rem;
    font-weight: 600;
    letter-spacing: 0.01em;
  }

  .funny-char {
    display: inline-block;
    animation: errorWave 0.72s ease-in-out infinite;
    animation-delay: calc(var(--i) * 45ms);
  }

  .form-row-animated {
    animation: fadeIn 0.65s ease both;
  }

  .form-row-animated.row-1 { animation-delay: 0.2s; }
  .form-row-animated.row-2 { animation-delay: 0.3s; }
  .form-row-animated.row-3 { animation-delay: 0.4s; }
  .form-row-animated.row-4 { animation-delay: 0.5s; }

  .field-label {
    display: block;
    margin-bottom: 0.28rem;
    font-size: 0.82rem;
    color: color-mix(in srgb, var(--text-main) 92%, transparent);
  }

  .field-control,
  .field-control:focus {
    width: 100%;
    border-radius: 10px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--input-text);
    padding: 0.62rem 0.68rem;
    font-size: 0.95rem;
    outline: none;
    box-shadow: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  }

  .field-control:focus {
    border-color: var(--title);
    box-shadow: 0 0 0 3px var(--input-focus);
  }

  .field-control.is-shaking {
    border-color: #ff637e;
    box-shadow: 0 0 0 3px rgba(255, 99, 126, 0.22);
    animation: inputShake 0.52s ease;
  }

  .field-password {
    position: relative;
  }

  .password-toggle {
    position: absolute;
    right: 0.45rem;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: transparent;
    color: #2b3265;
    font-size: 0.76rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    cursor: pointer;
    padding: 0.2rem;
  }

  .face-login-wrap {
    margin-top: 0.82rem;
    border: 1px solid color-mix(in srgb, var(--line-soft) 85%, transparent);
    border-radius: 12px;
    padding: 0.58rem;
    background: color-mix(in srgb, var(--input-bg) 10%, transparent);
  }

  .face-login-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.4rem;
    margin-bottom: 0.45rem;
  }

  .face-login-label {
    margin: 0;
    font-size: 0.8rem;
    color: color-mix(in srgb, var(--text-main) 90%, transparent);
  }

  .face-login-status {
    font-size: 0.72rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--line-soft) 85%, transparent);
    padding: 0.14rem 0.46rem;
    color: color-mix(in srgb, var(--text-main) 85%, transparent);
  }

  .face-login-status.success {
    border-color: rgba(110, 255, 192, 0.6);
    color: #8effdf;
  }

  .face-login-status.error {
    border-color: rgba(255, 126, 148, 0.62);
    color: #ffc9d5;
  }

  .face-login-video {
    width: 100%;
    max-width: 235px;
    aspect-ratio: 4 / 3;
    border-radius: 10px;
    border: 1px solid color-mix(in srgb, var(--line-soft) 90%, transparent);
    background: rgba(2, 5, 16, 0.68);
    object-fit: cover;
    display: block;
  }

  .face-login-actions {
    margin-top: 0.45rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .face-login-device-row {
    margin-top: 0.45rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .face-login-select {
    min-width: 190px;
    max-width: 260px;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--line-soft) 95%, transparent);
    background: color-mix(in srgb, var(--input-bg) 18%, transparent);
    color: var(--text-main);
    font-size: 0.75rem;
    padding: 0.28rem 0.7rem;
    line-height: 1.25;
    outline: none;
  }

  .face-login-select option {
    color: #1f2550;
  }

  .face-action-btn {
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--line-soft) 95%, transparent);
    background: color-mix(in srgb, var(--input-bg) 18%, transparent);
    color: var(--text-main);
    font-size: 0.75rem;
    padding: 0.28rem 0.7rem;
    line-height: 1.25;
  }

  .face-action-btn:hover:not(:disabled) {
    background: color-mix(in srgb, var(--input-bg) 34%, transparent);
  }

  .face-action-btn:disabled {
    opacity: 0.46;
  }

  .login-row {
    margin-top: 0.72rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    flex-wrap: wrap;
    font-size: 0.83rem;
  }

  .remember-check {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    color: color-mix(in srgb, var(--text-main) 88%, transparent);
  }

  .remember-check input {
    accent-color: #3be2ff;
  }

  .mute-link {
    color: color-mix(in srgb, var(--text-main) 76%, transparent);
    text-decoration: none;
  }

  .mute-link:hover {
    text-decoration: underline;
    color: color-mix(in srgb, var(--title) 72%, #fff 28%);
  }

  .btn-login {
    --btn-x: 0px;
    --btn-y: 0px;
    width: 100%;
    margin-top: 1rem;
    border: none;
    border-radius: 999px;
    padding: 0.7rem 1.1rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    color: white;
    background: linear-gradient(90deg, var(--btn-from), var(--btn-to));
    box-shadow: 0 10px 18px var(--btn-shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    transform: translate(var(--btn-x), var(--btn-y));
    animation: glowPulse 2s ease-in-out infinite;
  }

  .btn-login:hover {
    transform: translate(var(--btn-x), calc(var(--btn-y) - 1px));
    box-shadow: 0 14px 22px color-mix(in srgb, var(--btn-shadow) 70%, transparent);
  }

  .btn-login.btn-panicked {
    animation:
      glowPulse 1.15s ease-in-out infinite,
      panicPulse 0.5s ease-in-out 3;
  }

  .register-line {
    margin-top: 1rem;
    font-size: 0.87rem;
    color: color-mix(in srgb, var(--text-main) 86%, transparent);
  }

  .register-line a {
    color: color-mix(in srgb, var(--title) 85%, #fff 15%);
    text-decoration: none;
    font-weight: 600;
  }

  .register-line a:hover {
    text-decoration: underline;
  }

  .loading-overlay {
    position: fixed;
    inset: 0;
    z-index: 30;
    opacity: 0;
    pointer-events: none;
    display: grid;
    place-items: center;
    transition: opacity 0.24s ease;
    background: rgba(7, 7, 21, 0.48);
    backdrop-filter: blur(2px);
  }

  .loading-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

  .loading-card {
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.22);
    min-width: min(340px, 88vw);
    background: linear-gradient(140deg, rgba(22, 28, 72, 0.92), rgba(74, 17, 76, 0.85));
    color: #f4f8ff;
    padding: 1rem 1.2rem;
    text-align: center;
    box-shadow: 0 14px 30px rgba(7, 1, 25, 0.42);
  }

  .loading-overlay.denied .loading-card {
    background: linear-gradient(140deg, rgba(88, 10, 36, 0.94), rgba(130, 24, 32, 0.9));
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    margin: 0 auto 0.7rem;
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.28);
    border-top-color: #ffffff;
    animation: spin 0.86s linear infinite;
  }

  .loading-text {
    margin: 0;
    letter-spacing: 0.02em;
    font-size: 0.92rem;
  }

  .screen-flash {
    position: fixed;
    inset: 0;
    z-index: 35;
    pointer-events: none;
    opacity: 0;
    background: rgba(255, 0, 38, 0.38);
  }

  .screen-flash.active {
    animation: errorFlash 0.55s ease;
  }

  @keyframes slideUp {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    0% { opacity: 0; transform: translateY(14px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  @keyframes glowPulse {
    0%, 100% { box-shadow: 0 10px 18px var(--btn-shadow); }
    50% { box-shadow: 0 14px 25px color-mix(in srgb, var(--btn-shadow) 96%, transparent); }
  }

  @keyframes floatOrb {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-16px); }
  }

  @keyframes lightSweep {
    0% { transform: translateX(-130%); }
    100% { transform: translateX(130%); }
  }

  @keyframes faceFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }

  @keyframes inputShake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-6px); }
    80% { transform: translateX(6px); }
  }

  @keyframes panicPulse {
    0%, 100% { transform: translate(var(--btn-x), var(--btn-y)) scale(1); }
    50% { transform: translate(var(--btn-x), var(--btn-y)) scale(1.04); }
  }

  @keyframes errorWave {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }

  @keyframes spin {
    100% { transform: rotate(360deg); }
  }

  @keyframes errorFlash {
    0% { opacity: 0; }
    20% { opacity: 1; }
    100% { opacity: 0; }
  }

  @media (max-width: 980px) {
    .login-grid {
      grid-template-columns: 1fr;
      min-height: auto;
    }

    .login-info {
      border-right: none;
      border-bottom: 1px solid var(--line-soft);
    }
  }

  @media (max-width: 576px) {
    .login-shell {
      min-height: auto;
    }

    .login-frame {
      border-radius: 16px;
    }

    .form-top {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<section class="login-shell" id="loginShell" data-theme="dark">
  <div class="login-frame">
    <div class="login-grid">
      <aside class="login-info">
        <span class="info-badge">Smart Learning Portal</span>
        <h2 class="info-title">Welcome<br>Back Learner</h2>
        <p class="info-text">Login kore tomer dashboard, semester prediction, and personalized study plan access koro.</p>
        <ul class="info-list">
          <li>Track mark trends and attendance impact</li>
          <li>Get focused recommendations per subject</li>
          <li>Role-based access for Student and Teacher</li>
        </ul>
      </aside>

      <section class="login-form-wrap">
        <div class="form-top">
          <h3 class="login-title">
            Sign In <span class="reaction-emoji" id="reactionEmoji">ðŸ˜Ž</span>
          </h3>
          <button class="theme-toggle" type="button" id="themeToggle" aria-label="Switch to light mode">Light Mode</button>
        </div>
        <p class="login-subtitle">Use your account credentials to continue.</p>

        <div class="login-alert" id="errorBox" aria-live="polite" {% if not error %}style="display:none"{% endif %}>
          <div class="alert-topline">
            <span class="denied-pill">Access Denied</span>
            <span class="base-error" id="baseErrorText">{{ error|default:"Authentication failed." }}</span>
          </div>
          <div class="funny-line" id="funnyErrorLine"></div>
        </div>

        <form method="post" action="{% url 'login' %}" id="loginForm" novalidate>
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ next|default:'' }}">

          <div class="form-row-animated row-1">
            <label class="field-label" for="id_username">Username</label>
            <input
              class="field-control"
              type="text"
              id="id_username"
              name="username"
              value="{{ username|default:'' }}"
              autocomplete="username"
              required
            >
          </div>

          <div class="form-row-animated row-2" style="margin-top:0.72rem;">
            <label class="field-label" for="id_password">Password</label>
            <div class="field-password">
              <input
                class="field-control"
                type="password"
                id="id_password"
                name="password"
                autocomplete="current-password"
                required
              >
              <button class="password-toggle" type="button" id="togglePassword">SHOW</button>
            </div>
          </div>

          <div class="login-row form-row-animated row-3">
            <label class="remember-check" for="rememberMe">
              <input type="checkbox" id="rememberMe" name="remember_me">
              <span>Remember me</span>
            </label>
            <a class="mute-link" href="#">Forgot password?</a>
          </div>

          <button type="submit" class="btn-login form-row-animated row-4" id="loginBtn">Sign In</button>
        </form>

        <p class="register-line">No account yet? <a href="{% url 'register' %}">Create one now</a></p>
      </section>
    </div>
  </div>
</section>

<div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
  <div class="loading-card">
    <div class="loading-spinner"></div>
    <p class="loading-text" id="loadingText">Checking credentials...</p>
  </div>
</div>
<div class="screen-flash" id="screenFlash" aria-hidden="true"></div>

<script>
  (function () {
    var hasError = {% if error %}true{% else %}false{% endif %};
    var shell = document.getElementById("loginShell");
    var form = document.getElementById("loginForm");
    var loginBtn = document.getElementById("loginBtn");
    var toggle = document.getElementById("togglePassword");
    var password = document.getElementById("id_password");
    var emoji = document.getElementById("reactionEmoji");
    var themeToggle = document.getElementById("themeToggle");
    var errorBox = document.getElementById("errorBox");
    var baseErrorText = document.getElementById("baseErrorText");
    var funnyLine = document.getElementById("funnyErrorLine");
    var loadingOverlay = document.getElementById("loadingOverlay");
    var loadingText = document.getElementById("loadingText");
    var screenFlash = document.getElementById("screenFlash");
    var submitting = false;
    var COOL_FACE = "\uD83D\uDE0E";
    var ANGRY_FACE = "\uD83D\uDE21";

    if (!form || !loginBtn || !toggle || !password || !shell) {
      return;
    }

    function setTheme(theme) {
      var isLight = theme === "light";
      shell.setAttribute("data-theme", isLight ? "light" : "dark");
      themeToggle.textContent = isLight ? "Dark Mode" : "Light Mode";
      themeToggle.setAttribute("aria-label", isLight ? "Switch to dark mode" : "Switch to light mode");
    }

    function waveErrorText(message) {
      if (!funnyLine) {
        return;
      }
      funnyLine.innerHTML = "";
      message.split("").forEach(function (char, index) {
        var span = document.createElement("span");
        span.className = "funny-char";
        span.style.setProperty("--i", String(index));
        span.textContent = char === " " ? "\u00A0" : char;
        funnyLine.appendChild(span);
      });
    }

    function setBaseError(message) {
      if (!errorBox || !baseErrorText) {
        return;
      }
      errorBox.style.display = "";
      baseErrorText.textContent = message;
    }

    function triggerScreenFlash() {
      if (!screenFlash) {
        return;
      }
      screenFlash.classList.remove("active");
      void screenFlash.offsetWidth;
      screenFlash.classList.add("active");
    }

    function triggerPasswordShake() {
      password.classList.remove("is-shaking");
      void password.offsetWidth;
      password.classList.add("is-shaking");
      setTimeout(function () {
        password.classList.remove("is-shaking");
      }, 600);
    }

    function playFunnyErrorSound() {
      var AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) {
        return;
      }
      try {
        var ctx = new AudioCtx();
        var notes = [523.25, 392.0, 329.63, 246.94];
        var start = ctx.currentTime + 0.01;
        notes.forEach(function (freq, i) {
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();
          osc.type = i % 2 === 0 ? "triangle" : "square";
          osc.frequency.setValueAtTime(freq, start + i * 0.115);
          gain.gain.setValueAtTime(0.001, start + i * 0.115);
          gain.gain.exponentialRampToValueAtTime(0.09, start + i * 0.115 + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + i * 0.115 + 0.1);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(start + i * 0.115);
          osc.stop(start + i * 0.115 + 0.1);
        });
        setTimeout(function () {
          ctx.close();
        }, 900);
      } catch (err) {
      }
    }

    function dodgeButton() {
      if (!window.matchMedia("(pointer:fine)").matches) {
        return;
      }
      var x = (Math.random() * 30 - 15).toFixed(1) + "px";
      var y = (Math.random() * 16 - 8).toFixed(1) + "px";
      loginBtn.style.setProperty("--btn-x", x);
      loginBtn.style.setProperty("--btn-y", y);
    }

    function resetButtonPosition() {
      loginBtn.style.setProperty("--btn-x", "0px");
      loginBtn.style.setProperty("--btn-y", "0px");
    }

    function showLoading(message, denied) {
      if (!loadingOverlay || !loadingText) {
        return;
      }
      loadingText.textContent = message || "Checking credentials...";
      loadingOverlay.classList.toggle("denied", !!denied);
      loadingOverlay.classList.add("active");
    }

    function hideLoading() {
      if (!loadingOverlay || !loadingText) {
        return;
      }
      loadingOverlay.classList.remove("active", "denied");
      loadingText.textContent = "Checking credentials...";
    }

    var randomFunnyMessages = [
      "Oops! Password ta ajke chhuti te.",
      "Wrong turn boss! Keyboard ke ekbar jiggesh korun.",
      "Password mone hochhe coffee chara kaj korche na.",
      "Access denied! Secret code ta ektu mood off e ache.",
      "Naah, ei password diye gate khulbe na."
    ];

    function applyErrorEffects(baseMessage, funnyMessage) {
      shell.classList.add("error-mode");
      if (emoji) {
        emoji.textContent = ANGRY_FACE;
      }
      setBaseError(baseMessage || "Authentication failed.");
      loginBtn.classList.add("btn-panicked");
      waveErrorText(funnyMessage || randomFunnyMessages[Math.floor(Math.random() * randomFunnyMessages.length)]);
      triggerScreenFlash();
      playFunnyErrorSound();
    }

    var savedTheme = localStorage.getItem("login-theme");
    setTheme(savedTheme === "light" ? "light" : "dark");
    themeToggle.addEventListener("click", function () {
      var nextTheme = shell.getAttribute("data-theme") === "dark" ? "light" : "dark";
      setTheme(nextTheme);
      localStorage.setItem("login-theme", nextTheme);
    });

    toggle.addEventListener("click", function () {
      var show = password.type === "password";
      password.type = show ? "text" : "password";
      toggle.textContent = show ? "HIDE" : "SHOW";
    });

    loginBtn.addEventListener("mouseenter", dodgeButton);
    loginBtn.addEventListener("mouseleave", resetButtonPosition);

    form.addEventListener("submit", function (event) {
      if (submitting) {
        return;
      }
      event.preventDefault();
      submitting = true;
      if (emoji) {
        emoji.textContent = COOL_FACE;
      }
      showLoading("Checking credentials...", false);
      setTimeout(function () {
        if (loadingText) {
          loadingText.textContent = "Verifying access...";
        }
      }, 420);
      setTimeout(function () {
        form.submit();
      }, 1100);
    });

    if (hasError) {
      applyErrorEffects("Invalid username or password.");
      triggerPasswordShake();
      password.value = "";
      password.focus();
      showLoading("Access Denied", true);
      setTimeout(hideLoading, 1000);
    }
  })();
</script>
{% endblock %}


